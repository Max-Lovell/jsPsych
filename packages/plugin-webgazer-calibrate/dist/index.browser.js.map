{"version":3,"file":"index.browser.js","sources":["../src/index.ts"],"sourcesContent":["import type WebGazerExtension from \"@jspsych/extension-webgazer\";\nimport { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nimport { version } from \"../package.json\";\n\nconst info = <const>{\n  name: \"webgazer-calibrate\",\n  version: version,\n  parameters: {\n    /** Array of points in `[x,y]` coordinates. Specified as a percentage of the screen width and height, from the left and top edge. The default grid is 9 points. */\n    calibration_points: {\n      type: ParameterType.INT, // TO DO: nested array, so different type?\n      default: [\n        [10, 10],\n        [10, 50],\n        [10, 90],\n        [50, 10],\n        [50, 50],\n        [50, 90],\n        [90, 10],\n        [90, 50],\n        [90, 90],\n      ],\n      array: true,\n    },\n    /** Can specify `click` to have participants click on calibration points or `view` to have participants passively watch calibration points.  */\n    calibration_mode: {\n      type: ParameterType.SELECT,\n      options: [\"click\", \"view\"],\n      default: \"click\",\n    },\n    /** Diameter of the calibration points in pixels. */\n    point_size: {\n      type: ParameterType.INT,\n      default: 20,\n    },\n    /** The number of times to repeat the sequence of calibration points. */\n    repetitions_per_point: {\n      type: ParameterType.INT,\n      default: 1,\n    },\n    /** Whether to randomize the order of the calibration points. */\n    randomize_calibration_order: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n    /** If `calibration_mode` is set to `view`, then this is the delay before calibrating after showing a point.\n     * Gives the participant time to fixate on the new target before assuming that the participant is looking at the target. */\n    time_to_saccade: {\n      type: ParameterType.INT,\n      default: 1000,\n    },\n    /**\n     * If `calibration_mode` is set to `view`, then this is the length of time to show a point while calibrating. Note\n     * that if `click` calibration is used then the point will remain on the screen until clicked.\n     */\n    time_per_point: {\n      type: ParameterType.INT,\n      default: 1000,\n    },\n  },\n  data: {\n    // no data collected\n  },\n};\n\ntype Info = typeof info;\n\n/**\n *\n * This plugin can be used to calibrate the [WebGazer extension](../extensions/webgazer.md). For a narrative\n * description of eye tracking with jsPsych, see the [eye tracking overview](../overview/eye-tracking.md).\n *\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/latest/plugins/webgazer-calibrate/ webgazer-calibrate plugin} and\n * {@link https://www.jspsych.org/latest/overview/eye-tracking/ eye-tracking overview} documentation on jspsych.org\n */\nclass WebgazerCalibratePlugin implements JsPsychPlugin<Info> {\n  static info = info;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    const extension = this.jsPsych.extensions.webgazer as WebGazerExtension;\n\n    var html = `\n          <div id='webgazer-calibrate-container' style='position: relative; width:100vw; height:100vh'>\n          </div>`;\n\n    display_element.innerHTML = html;\n\n    var wg_container = display_element.querySelector(\"#webgazer-calibrate-container\");\n\n    var reps_completed = 0;\n    var points_completed = -1;\n    var cal_points = null;\n\n    const next_calibration_round = () => {\n      if (trial.randomize_calibration_order) {\n        cal_points = this.jsPsych.randomization.shuffle(trial.calibration_points);\n      } else {\n        cal_points = trial.calibration_points;\n      }\n      points_completed = -1;\n      next_calibration_point();\n    };\n\n    const calibrate = () => {\n      extension.resume();\n      if (trial.calibration_mode == \"click\") {\n        extension.startMouseCalibration();\n      }\n      next_calibration_round();\n    };\n\n    const next_calibration_point = () => {\n      points_completed++;\n      if (points_completed == cal_points.length) {\n        reps_completed++;\n        if (reps_completed == trial.repetitions_per_point) {\n          calibration_done();\n        } else {\n          next_calibration_round();\n        }\n      } else {\n        var pt = cal_points[points_completed];\n        calibration_display_gaze_only(pt);\n      }\n    };\n\n    const calibration_display_gaze_only = (pt) => {\n      var pt_html = `<div id=\"calibration-point\" style=\"width:${trial.point_size}px; height:${trial.point_size}px; border-radius:${trial.point_size}px; border: 1px solid #000; background-color: #333; position: absolute; left:${pt[0]}%; top:${pt[1]}%;\"></div>`;\n      wg_container.innerHTML = pt_html;\n\n      var pt_dom = wg_container.querySelector<HTMLElement>(\"#calibration-point\");\n\n      if (trial.calibration_mode == \"click\") {\n        pt_dom.style.cursor = \"pointer\";\n        pt_dom.addEventListener(\"click\", () => {\n          next_calibration_point();\n        });\n      }\n\n      if (trial.calibration_mode == \"view\") {\n        var br = pt_dom.getBoundingClientRect();\n        var x = br.left + br.width / 2;\n        var y = br.top + br.height / 2;\n\n        var pt_start_cal: number = performance.now() + trial.time_to_saccade;\n        var pt_finish: number = performance.now() + trial.time_to_saccade + trial.time_per_point;\n\n        const watch_dot = () => {\n          if (performance.now() > pt_start_cal) {\n            extension.calibratePoint(x, y);\n          }\n          if (performance.now() < pt_finish) {\n            requestAnimationFrame(watch_dot);\n          } else {\n            next_calibration_point();\n          }\n        };\n\n        requestAnimationFrame(watch_dot);\n      }\n    };\n\n    const calibration_done = () => {\n      if (trial.calibration_mode == \"click\") {\n        extension.stopMouseCalibration();\n      }\n      wg_container.innerHTML = \"\";\n      end_trial();\n    };\n\n    // function to end trial when it is time\n    const end_trial = () => {\n      extension.pause();\n      extension.hidePredictions();\n      extension.hideVideo();\n\n      // gather the data to store for the trial\n      var trial_data = {};\n\n      // move on to the next trial\n      this.jsPsych.finishTrial(trial_data);\n    };\n\n    calibrate();\n  }\n}\n\nexport default WebgazerCalibratePlugin;\n"],"names":["version","ParameterType"],"mappings":"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"}