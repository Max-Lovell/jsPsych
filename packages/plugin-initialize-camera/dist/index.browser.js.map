{"version":3,"file":"index.browser.js","sources":["../src/index.ts"],"sourcesContent":["import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nimport { version } from \"../package.json\";\n\nconst info = <const>{\n  name: \"initialize-camera\",\n  version: version,\n  parameters: {\n    /** The message to display when the user is presented with a dropdown list of available devices. */\n    device_select_message: {\n      type: ParameterType.HTML_STRING,\n      default: `<p>Please select the camera you would like to use.</p>`,\n    },\n    /** The label for the select button. */\n    button_label: {\n      type: ParameterType.STRING,\n      default: \"Use this camera\",\n    },\n    /** Set to `true` to include an audio track in the recordings. */\n    include_audio: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n    /** Request a specific width for the recording. This is not a guarantee that this width will be used, as it\n     * depends on the capabilities of the participant's device. Learn more about `MediaRecorder` constraints\n     * [here](https://developer.mozilla.org/en-US/docs/Web/API/Media_Streams_API/Constraints#requesting_a_specific_value_for_a_setting). */\n    width: {\n      type: ParameterType.INT,\n      default: null,\n    },\n    /** Request a specific height for the recording. This is not a guarantee that this height will be used, as it\n     * depends on the capabilities of the participant's device. Learn more about `MediaRecorder` constraints\n     * [here](https://developer.mozilla.org/en-US/docs/Web/API/Media_Streams_API/Constraints#requesting_a_specific_value_for_a_setting). */\n    height: {\n      type: ParameterType.INT,\n      default: null,\n    },\n    /** Set this to use a specific [MIME type](https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder/mimeType) for the\n     * recording. Set the entire type, e.g., `'video/mp4; codecs=\"avc1.424028, mp4a.40.2\"'`. */\n    mime_type: {\n      type: ParameterType.STRING,\n      default: null,\n    },\n  },\n  data: {\n    /** The [device ID](https://developer.mozilla.org/en-US/docs/Web/API/MediaDeviceInfo/deviceId) of the selected camera. */\n    device_id: {\n      type: ParameterType.STRING,\n    },\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * This plugin asks the participant to grant permission to access a camera.\n * If multiple cameras are connected to the participant's device, then it allows the participant to pick which device to use.\n * Once access is granted for an experiment you do not need to get permission again.\n *\n * Once the camera is selected with this plugin it can be accessed with\n * [`jsPsych.pluginAPI.getCameraRecorder()`](../reference/jspsych-pluginAPI.md#getcamerarecorder).\n *\n * !!! warning\n *     When recording from a camera your experiment will need to be running over `https://` protocol. If you try to\n *  run the experiment locally using the `file://` protocol or over `http://` protocol you will not be able to access\n * the microphone because of [potential security problems](https://blog.mozilla.org/webrtc/camera-microphone-require-https-in-firefox-68/).\n *\n *\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/latest/plugins/initialize-camera/ initialize-camera plugin documentation on jspsych.org}\n */\nclass InitializeCameraPlugin implements JsPsychPlugin<Info> {\n  static info = info;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    this.run_trial(display_element, trial).then((id) => {\n      this.jsPsych.finishTrial({\n        device_id: id,\n      });\n    });\n  }\n\n  private async run_trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    await this.askForPermission(trial);\n\n    this.showCameraSelection(display_element, trial);\n\n    this.updateDeviceList(display_element);\n\n    navigator.mediaDevices.ondevicechange = (e) => {\n      this.updateDeviceList(display_element);\n    };\n\n    const camera_id = await this.waitForSelection(display_element);\n\n    const constraints: any = { video: { deviceId: camera_id } };\n\n    if (trial.width) {\n      constraints.video.width = trial.width;\n    }\n    if (trial.height) {\n      constraints.video.height = trial.height;\n    }\n    if (trial.include_audio) {\n      constraints.audio = true;\n    }\n\n    const stream = await navigator.mediaDevices.getUserMedia(constraints);\n\n    const recorder_options: MediaRecorderOptions = {};\n    if (trial.mime_type) {\n      recorder_options.mimeType = trial.mime_type;\n    }\n\n    this.jsPsych.pluginAPI.initializeCameraRecorder(stream, recorder_options);\n\n    return camera_id;\n  }\n\n  private async askForPermission(trial: TrialType<Info>) {\n    const stream = await navigator.mediaDevices.getUserMedia({\n      audio: trial.include_audio,\n      video: true,\n    });\n    return stream;\n  }\n\n  private showCameraSelection(display_element, trial: TrialType<Info>) {\n    let html = `\n      ${trial.device_select_message}\n      <select name=\"camera\" id=\"which-camera\" style=\"font-size:14px; font-family: 'Open Sans', 'Arial', sans-serif; padding: 4px;\">\n      </select>\n      <p><button class=\"jspsych-btn\" id=\"btn-select-camera\">${trial.button_label}</button></p>`;\n    display_element.innerHTML = html;\n  }\n\n  private waitForSelection(display_element) {\n    return new Promise((resolve) => {\n      display_element.querySelector(\"#btn-select-camera\").addEventListener(\"click\", () => {\n        const camera = display_element.querySelector(\"#which-camera\").value;\n        resolve(camera);\n      });\n    });\n  }\n\n  private updateDeviceList(display_element) {\n    navigator.mediaDevices.enumerateDevices().then((devices) => {\n      const cams = devices.filter(\n        (d) =>\n          d.kind === \"videoinput\" && d.deviceId !== \"default\" && d.deviceId !== \"communications\"\n      );\n\n      // remove entries with duplicate groupID\n      const unique_cameras = cams.filter(\n        (cam, index, arr) => arr.findIndex((v) => v.groupId == cam.groupId) == index\n      );\n\n      // reset the list by clearing all current options\n      display_element.querySelector(\"#which-camera\").innerHTML = \"\";\n\n      unique_cameras.forEach((d) => {\n        let el = document.createElement(\"option\");\n        el.value = d.deviceId;\n        el.innerHTML = d.label;\n\n        display_element.querySelector(\"#which-camera\").appendChild(el);\n      });\n    });\n  }\n}\n\nexport default InitializeCameraPlugin;\n"],"names":["version","ParameterType"],"mappings":"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"}