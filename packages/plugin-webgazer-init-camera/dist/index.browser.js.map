{"version":3,"file":"index.browser.js","sources":["../src/index.ts"],"sourcesContent":["import type WebGazerExtension from \"@jspsych/extension-webgazer\";\nimport { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nimport { version } from \"../package.json\";\n\nconst info = <const>{\n  name: \"webgazer-init-camera\",\n  version: version,\n  parameters: {\n    /** Instructions for the participant to follow. */\n    instructions: {\n      type: ParameterType.HTML_STRING,\n      default: `\n            <p>Position your head so that the webcam has a good view of your eyes.</p>\n            <p>Center your face in the box and look directly towards the camera.</p>\n            <p>It is important that you try and keep your head reasonably still throughout the experiment, so please take a moment to adjust your setup to be comfortable.</p>\n            <p>When your face is centered in the box and the box is green, you can click to continue.</p>`,\n    },\n    /** The text for the button that participants click to end the trial. */\n    button_text: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n  },\n  data: {\n    /** The time it took for webgazer to initialize. This can be a long time in some situations, so this\n     * value is recorded for troubleshooting when participants are reporting difficulty.\n     */\n    load_time: {\n      type: ParameterType.INT,\n    },\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * This plugin initializes the camera and helps the participant center their face in the camera view for\n * using the the [WebGazer extension](../extensions/webgazer.md). For a narrative description of eye\n * tracking with jsPsych, see the [eye tracking overview](../overview/eye-tracking.md).\n *\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/latest/plugins/webgazer-init-camera/ webgazer-init-camera plugin} and\n * {@link https://www.jspsych.org/latest/overview/eye-tracking/ eye-tracking overview} documentation on jspsych.org\n */\nclass WebgazerInitCameraPlugin implements JsPsychPlugin<Info> {\n  static info = info;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>, on_load: () => void) {\n    const extension = this.jsPsych.extensions.webgazer as WebGazerExtension;\n\n    let trial_complete;\n\n    var start_time = performance.now();\n    var load_time: number;\n\n    // function to end trial when it is time\n    const end_trial = () => {\n      extension.pause();\n      extension.hideVideo();\n\n      // gather the data to store for the trial\n      var trial_data = {\n        load_time: load_time,\n      };\n\n      document.querySelector(\"#webgazer-center-style\").remove();\n\n      // move on to the next trial\n      this.jsPsych.finishTrial(trial_data);\n\n      trial_complete();\n    };\n\n    const showTrial = () => {\n      on_load();\n\n      load_time = Math.round(performance.now() - start_time);\n\n      var style = `\n          <style id=\"webgazer-center-style\">\n            #webgazerVideoContainer { top: 20px !important; left: calc(50% - 160px) !important;}\n          </style>\n        `;\n      document.querySelector(\"head\").insertAdjacentHTML(\"beforeend\", style);\n\n      var html = `\n          <div id='webgazer-init-container' style='position: relative; width:100vw; height:100vh'>\n          </div>`;\n\n      display_element.innerHTML = html;\n\n      extension.showVideo();\n      extension.resume();\n\n      var wg_container = display_element.querySelector(\"#webgazer-init-container\");\n\n      wg_container.innerHTML = `\n          <div style='position: absolute; top: max(260px, 40%); left: calc(50% - 400px); width:800px;'>\n          ${trial.instructions}\n          <button id='jspsych-wg-cont' class='jspsych-btn' disabled>${trial.button_text}</button>\n          </div>`;\n\n      if (is_face_detect_green()) {\n        (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = false;\n      } else {\n        var observer = new MutationObserver(face_detect_event_observer);\n        observer.observe(document, {\n          attributes: true,\n          attributeFilter: [\"style\"],\n          subtree: true,\n        });\n      }\n\n      document.querySelector(\"#jspsych-wg-cont\").addEventListener(\"click\", () => {\n        if (observer) {\n          observer.disconnect();\n        }\n        end_trial();\n      });\n    };\n\n    if (!extension.isInitialized()) {\n      extension\n        .start()\n        .then(() => {\n          showTrial();\n        })\n        .catch((error) => {\n          console.log(error);\n          display_element.innerHTML = `<p>The experiment cannot continue because the eye tracker failed to start.</p>\n              <p>This may be because of a technical problem or because you did not grant permission for the page to use your camera.</p>`;\n        });\n    } else {\n      showTrial();\n    }\n\n    function is_face_detect_green() {\n      if (document.querySelector(\"#webgazerFaceFeedbackBox\")) {\n        return (\n          (document.querySelector(\"#webgazerFaceFeedbackBox\") as HTMLElement).style.borderColor ==\n          \"green\"\n        );\n      } else {\n        return false;\n      }\n    }\n\n    function face_detect_event_observer(mutationsList, observer) {\n      if (mutationsList[0].target == document.querySelector(\"#webgazerFaceFeedbackBox\")) {\n        if (\n          mutationsList[0].type == \"attributes\" &&\n          mutationsList[0].target.style.borderColor == \"green\"\n        ) {\n          (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = false;\n        }\n        if (\n          mutationsList[0].type == \"attributes\" &&\n          mutationsList[0].target.style.borderColor == \"red\"\n        ) {\n          (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = true;\n        }\n      }\n    }\n\n    return new Promise((resolve) => {\n      trial_complete = resolve;\n    });\n  }\n}\n\nexport default WebgazerInitCameraPlugin;\n"],"names":["version","ParameterType"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAKA,MAAM,IAAc,GAAA;EAAA,EAClB,IAAM,EAAA,sBAAA;EAAA,WACNA,gBAAA;EAAA,EACA,UAAY,EAAA;EAAA,IAEV,YAAc,EAAA;EAAA,MACZ,MAAMC,qBAAc,CAAA,WAAA;EAAA,MACpB,OAAS,EAAA,CAAA;AAAA;AAAA;AAAA;AAAA,yGAAA,CAAA;EAAA,KAKX;EAAA,IAEA,WAAa,EAAA;EAAA,MACX,MAAMA,qBAAc,CAAA,MAAA;EAAA,MACpB,OAAS,EAAA,UAAA;EAAA,KACX;EAAA,GACF;EAAA,EACA,IAAM,EAAA;EAAA,IAIJ,SAAW,EAAA;EAAA,MACT,MAAMA,qBAAc,CAAA,GAAA;EAAA,KACtB;EAAA,GACF;EACF,CAAA,CAAA;EAaA,MAAM,wBAAwD,CAAA;EAAA,EAG5D,YAAoB,OAAkB,EAAA;EAAlB,IAAA,IAAA,CAAA,OAAA,GAAA,OAAA,CAAA;EAAA,GAAmB;EAAA,EAFvC,OAAO,IAAO,GAAA,IAAA,CAAA;EAAA,EAId,KAAA,CAAM,eAA8B,EAAA,KAAA,EAAwB,OAAqB,EAAA;EAC/E,IAAM,MAAA,SAAA,GAAY,IAAK,CAAA,OAAA,CAAQ,UAAW,CAAA,QAAA,CAAA;EAE1C,IAAI,IAAA,cAAA,CAAA;EAEJ,IAAI,IAAA,UAAA,GAAa,YAAY,GAAI,EAAA,CAAA;EACjC,IAAI,IAAA,SAAA,CAAA;EAGJ,IAAA,MAAM,YAAY,MAAM;EACtB,MAAA,SAAA,CAAU,KAAM,EAAA,CAAA;EAChB,MAAA,SAAA,CAAU,SAAU,EAAA,CAAA;EAGpB,MAAA,IAAI,UAAa,GAAA;EAAA,QACf,SAAA;EAAA,OACF,CAAA;EAEA,MAAS,QAAA,CAAA,aAAA,CAAc,wBAAwB,CAAA,CAAE,MAAO,EAAA,CAAA;EAGxD,MAAK,IAAA,CAAA,OAAA,CAAQ,YAAY,UAAU,CAAA,CAAA;EAEnC,MAAe,cAAA,EAAA,CAAA;EAAA,KACjB,CAAA;EAEA,IAAA,MAAM,YAAY,MAAM;EACtB,MAAQ,OAAA,EAAA,CAAA;EAER,MAAA,SAAA,GAAY,IAAK,CAAA,KAAA,CAAM,WAAY,CAAA,GAAA,KAAQ,UAAU,CAAA,CAAA;EAErD,MAAA,IAAI,KAAQ,GAAA,CAAA;AAAA;AAAA;AAAA;AAAA,QAAA,CAAA,CAAA;EAKZ,MAAA,QAAA,CAAS,aAAc,CAAA,MAAM,CAAE,CAAA,kBAAA,CAAmB,aAAa,KAAK,CAAA,CAAA;EAEpE,MAAA,IAAI,IAAO,GAAA,CAAA;AAAA;AAAA,gBAAA,CAAA,CAAA;EAIX,MAAA,eAAA,CAAgB,SAAY,GAAA,IAAA,CAAA;EAE5B,MAAA,SAAA,CAAU,SAAU,EAAA,CAAA;EACpB,MAAA,SAAA,CAAU,MAAO,EAAA,CAAA;EAEjB,MAAI,IAAA,YAAA,GAAe,eAAgB,CAAA,aAAA,CAAc,0BAA0B,CAAA,CAAA;EAE3E,MAAA,YAAA,CAAa,SAAY,GAAA,CAAA;AAAA;AAAA,UAAA,EAEnB,KAAM,CAAA,YAAA,CAAA;AAAA,oEAAA,EACoD,KAAM,CAAA,WAAA,CAAA;AAAA,gBAAA,CAAA,CAAA;EAGtE,MAAA,IAAI,sBAAwB,EAAA;EAC1B,QAAC,QAAS,CAAA,aAAA,CAAc,kBAAkB,CAAA,CAAwB,QAAW,GAAA,KAAA,CAAA;EAAA,OACxE,MAAA;EACL,QAAI,IAAA,QAAA,GAAW,IAAI,gBAAA,CAAiB,0BAA0B,CAAA,CAAA;EAC9D,QAAA,QAAA,CAAS,QAAQ,QAAU,EAAA;EAAA,UACzB,UAAY,EAAA,IAAA;EAAA,UACZ,eAAA,EAAiB,CAAC,OAAO,CAAA;EAAA,UACzB,OAAS,EAAA,IAAA;EAAA,SACV,CAAA,CAAA;EAAA,OACH;EAEA,MAAA,QAAA,CAAS,aAAc,CAAA,kBAAkB,CAAE,CAAA,gBAAA,CAAiB,SAAS,MAAM;EACzE,QAAA,IAAI,QAAU,EAAA;EACZ,UAAA,QAAA,CAAS,UAAW,EAAA,CAAA;EAAA,SACtB;EACA,QAAU,SAAA,EAAA,CAAA;EAAA,OACX,CAAA,CAAA;EAAA,KACH,CAAA;EAEA,IAAI,IAAA,CAAC,SAAU,CAAA,aAAA,EAAiB,EAAA;EAC9B,MACG,SAAA,CAAA,KAAA,EACA,CAAA,IAAA,CAAK,MAAM;EACV,QAAU,SAAA,EAAA,CAAA;EAAA,OACX,CAAA,CACA,KAAM,CAAA,CAAC,KAAU,KAAA;EAChB,QAAA,OAAA,CAAQ,IAAI,KAAK,CAAA,CAAA;EACjB,QAAA,eAAA,CAAgB,SAAY,GAAA,CAAA;AAAA,wIAAA,CAAA,CAAA;EAAA,OAE7B,CAAA,CAAA;EAAA,KACE,MAAA;EACL,MAAU,SAAA,EAAA,CAAA;EAAA,KACZ;EAEA,IAAA,SAAS,oBAAuB,GAAA;EAC9B,MAAI,IAAA,QAAA,CAAS,aAAc,CAAA,0BAA0B,CAAG,EAAA;EACtD,QAAA,OACG,QAAS,CAAA,aAAA,CAAc,0BAA0B,CAAA,CAAkB,MAAM,WAC1E,IAAA,OAAA,CAAA;EAAA,OAEG,MAAA;EACL,QAAO,OAAA,KAAA,CAAA;EAAA,OACT;EAAA,KACF;EAEA,IAAS,SAAA,0BAAA,CAA2B,eAAe,QAAU,EAAA;EAC3D,MAAA,IAAI,cAAc,CAAG,CAAA,CAAA,MAAA,IAAU,QAAS,CAAA,aAAA,CAAc,0BAA0B,CAAG,EAAA;EACjF,QACE,IAAA,aAAA,CAAc,GAAG,IAAQ,IAAA,YAAA,IACzB,cAAc,CAAG,CAAA,CAAA,MAAA,CAAO,KAAM,CAAA,WAAA,IAAe,OAC7C,EAAA;EACA,UAAC,QAAS,CAAA,aAAA,CAAc,kBAAkB,CAAA,CAAwB,QAAW,GAAA,KAAA,CAAA;EAAA,SAC/E;EACA,QACE,IAAA,aAAA,CAAc,GAAG,IAAQ,IAAA,YAAA,IACzB,cAAc,CAAG,CAAA,CAAA,MAAA,CAAO,KAAM,CAAA,WAAA,IAAe,KAC7C,EAAA;EACA,UAAC,QAAS,CAAA,aAAA,CAAc,kBAAkB,CAAA,CAAwB,QAAW,GAAA,IAAA,CAAA;EAAA,SAC/E;EAAA,OACF;EAAA,KACF;EAEA,IAAO,OAAA,IAAI,OAAQ,CAAA,CAAC,OAAY,KAAA;EAC9B,MAAiB,cAAA,GAAA,OAAA,CAAA;EAAA,KAClB,CAAA,CAAA;EAAA,GACH;EACF;;;;;;;;"}