{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import autoBind from \"auto-bind\";\nimport { JsPsych, JsPsychExtension, JsPsychExtensionInfo, ParameterType } from \"jspsych\";\n\nimport { version } from \"../package.json\";\n\n/**\n * https://www.jspsych.org/latest/extensions/record-video/\n */\nclass RecordVideoExtension implements JsPsychExtension {\n  static info: JsPsychExtensionInfo = {\n    name: \"record-video\",\n    version: version,\n    data: {\n      /** [Base 64 encoded](https://developer.mozilla.org/en-US/docs/Glossary/Base64) representation of the video data. */\n      record_video_data: {\n        type: ParameterType.STRING,\n      },\n    },\n  };\n\n  constructor(private jsPsych: JsPsych) {\n    autoBind(this);\n  }\n\n  private recordedChunks = [];\n  private recorder: MediaRecorder = null;\n  private currentTrialData = null;\n  private trialComplete = false;\n  private onUpdateCallback: () => void = null;\n\n  // todo: add option to stream data to server with timeslice?\n  initialize = async () => {};\n\n  on_start = (): void => {\n    this.recorder = this.jsPsych.pluginAPI.getCameraRecorder();\n    this.recordedChunks = [];\n    this.trialComplete = false;\n    this.currentTrialData = {};\n\n    if (!this.recorder) {\n      console.warn(\n        \"The record-video extension is trying to start but the camera is not initialized. Do you need to run the initialize-camera plugin?\"\n      );\n      return;\n    }\n\n    this.recorder.addEventListener(\"dataavailable\", this.handleOnDataAvailable);\n  };\n\n  on_load = () => {\n    this.recorder.start();\n  };\n\n  on_finish = (): Promise<any> => {\n    return new Promise((resolve) => {\n      this.trialComplete = true;\n      this.recorder.stop();\n\n      if (!this.currentTrialData.record_video_data) {\n        this.onUpdateCallback = () => {\n          resolve(this.currentTrialData);\n        };\n      } else {\n        resolve(this.currentTrialData);\n      }\n    });\n  };\n\n  private handleOnDataAvailable(event) {\n    if (event.data.size > 0) {\n      console.log(\"chunks added\");\n      this.recordedChunks.push(event.data);\n      if (this.trialComplete) {\n        this.updateData();\n      }\n    }\n  }\n\n  private updateData() {\n    const data = new Blob(this.recordedChunks, {\n      type: this.recorder.mimeType,\n    });\n    const reader = new FileReader();\n    reader.addEventListener(\"load\", () => {\n      const base64 = (reader.result as string).split(\",\")[1];\n      this.currentTrialData.record_video_data = base64;\n      if (this.onUpdateCallback) {\n        this.onUpdateCallback();\n      }\n    });\n    reader.readAsDataURL(data);\n  }\n}\n\nexport default RecordVideoExtension;\n"],"names":["version"],"mappings":"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"}