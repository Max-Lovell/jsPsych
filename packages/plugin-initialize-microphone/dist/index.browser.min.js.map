{"version":3,"file":"index.browser.min.js","sources":["../src/index.ts"],"sourcesContent":["import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nimport { version } from \"../package.json\";\n\nconst info = <const>{\n  name: \"initialize-microphone\",\n  version: version,\n  parameters: {\n    /** The message to display when the user is presented with a dropdown list of available devices. */\n    device_select_message: {\n      type: ParameterType.HTML_STRING,\n      default: `<p>Please select the microphone you would like to use.</p>`,\n    },\n    /** The label for the select button. */\n    button_label: {\n      type: ParameterType.STRING,\n      default: \"Use this microphone\",\n    },\n  },\n  data: {\n    /**  The [device ID](https://developer.mozilla.org/en-US/docs/Web/API/MediaDeviceInfo/deviceId) of the selected microphone. */\n    device_id: {\n      type: ParameterType.STRING,\n    },\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * This plugin asks the participant to grant permission to access a microphone.\n * If multiple microphones are connected to the participant's device, then it allows the participant to pick which device to use.\n * Once access is granted for an experiment you do not need to get permission again.\n *\n * Once the microphone is selected with this plugin it can be accessed with\n * [`jsPsych.pluginAPI.getMicrophoneRecorder()`](../reference/jspsych-pluginAPI.md#getmicrophonerecorder).\n *\n * !!! warning\n *     When recording from a microphone your experiment will need to be running over `https://` protocol.\n * If you try to run the experiment locally using the `file://` protocol or over `http://` protocol you will not\n * be able to access the microphone because of\n * [potential security problems](https://blog.mozilla.org/webrtc/camera-microphone-require-https-in-firefox-68/).\n *\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/latest/plugins/initialize-microphone/ initialize-microphone plugin documentation on jspsych.org}\n */\nclass InitializeMicrophonePlugin implements JsPsychPlugin<Info> {\n  static info = info;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    this.run_trial(display_element, trial).then((id) => {\n      this.jsPsych.finishTrial({\n        device_id: id,\n      });\n    });\n  }\n\n  private async run_trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    await this.askForPermission();\n\n    this.showMicrophoneSelection(display_element, trial);\n\n    this.updateDeviceList(display_element);\n\n    navigator.mediaDevices.ondevicechange = (e) => {\n      this.updateDeviceList(display_element);\n    };\n\n    const mic_id = await this.waitForSelection(display_element);\n\n    const stream = await navigator.mediaDevices.getUserMedia({ audio: { deviceId: mic_id } });\n\n    this.jsPsych.pluginAPI.initializeMicrophoneRecorder(stream);\n\n    return mic_id;\n  }\n\n  private async askForPermission() {\n    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });\n    return stream;\n  }\n\n  private showMicrophoneSelection(display_element, trial: TrialType<Info>) {\n    let html = `\n      ${trial.device_select_message}\n      <select name=\"mic\" id=\"which-mic\" style=\"font-size:14px; font-family: 'Open Sans', 'Arial', sans-serif; padding: 4px;\">\n      </select>\n      <p><button class=\"jspsych-btn\" id=\"btn-select-mic\">${trial.button_label}</button></p>`;\n    display_element.innerHTML = html;\n  }\n\n  private waitForSelection(display_element) {\n    return new Promise((resolve) => {\n      display_element.querySelector(\"#btn-select-mic\").addEventListener(\"click\", () => {\n        const mic = display_element.querySelector(\"#which-mic\").value;\n        resolve(mic);\n      });\n    });\n  }\n\n  private updateDeviceList(display_element) {\n    navigator.mediaDevices.enumerateDevices().then((devices) => {\n      const mics = devices.filter(\n        (d) =>\n          d.kind === \"audioinput\" && d.deviceId !== \"default\" && d.deviceId !== \"communications\"\n      );\n\n      // remove entries with duplicate groupID\n      const unique_mics = mics.filter(\n        (mic, index, arr) => arr.findIndex((v) => v.groupId == mic.groupId) == index\n      );\n\n      // reset the list by clearing all current options\n      display_element.querySelector(\"#which-mic\").innerHTML = \"\";\n\n      unique_mics.forEach((d) => {\n        let el = document.createElement(\"option\");\n        el.value = d.deviceId;\n        el.innerHTML = d.label;\n\n        display_element.querySelector(\"#which-mic\").appendChild(el);\n      });\n    });\n  }\n}\n\nexport default InitializeMicrophonePlugin;\n"],"names":["l","h","t","a","s","c","o","r","n","info","version","ParameterType","InitializeMicrophonePlugin","jsPsych","display_element","trial","id","__async","e","mic_id","stream","html","resolve","mic","devices","unique_mics","d","index","arr","v","el"],"mappings":"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"}